---
title: "Biodiversity analysis"
subtitle: "East Gippsland (extended area)" 
format:
  html:
    embed-resources: true
    toc: true
    toc-depth: 2
editor: source
execute:
  echo: false
  message: false
  warning: false
---

```{r library}
# Library
lib <- c("targets","tarchetypes",
         "tidyverse","sf","galah","terra",
         "tidyterra","tmap","leaflet","plotly")
invisible(lapply(lib, library, character.only = TRUE))
rm(lib)

# Targets config
tar_config_set(store = here::here("_targets"))

# Create a custom theme
theme_minimal_hpha0042 <- theme_minimal() +
  theme(
    # Plot title & subtitle
    plot.title = element_text(face = 'bold'),
    plot.title.position = "plot",
    plot.subtitle = element_text(color = "grey20", size = 12)
  )
theme_set(theme_minimal_hpha0042)
```

### Data Wragnling   

```{r}
# PREPARE DATA FOR VISUALISATION
fire1920_timeframe <- data.frame(
  start_date = as.POSIXct(c("2019-11-22", "2019-11-22")), 
  end_date = as.POSIXct(c("2020-03-01", "2020-03-01")))

# Define color palette
report_pal <- setNames(RColorBrewer::brewer.pal(n=8,name="Set2")[c(1,2)],
              c("parkres","fire"))
```

```{r}
tar_load(sighting) # ref to _targets.R

# 1. Create SpatRaster grid template with the same extent as the sighting data
grid_template <- terra::rast(
  x = sighting,           # Use the extent of the 'sighting' sf object
  crs = "epsg:7844",      # CRS = GDA2020 
  resolution = 1 / 3000   # Set the desired resolution (~1000m^2 per grid cell)
)

# 2. Assign unique IDs to the grid cells (cell numbers)
# The cell numbers will be used as grid cell IDs
grid_template <- terra::setValues(grid_template, 1:ncell(grid_template))

# 3. Convert sf points (sighting) to coordinates
# Convert sf POINT to terra SpatVector                                               
sighting_v <- terra::vect(sighting[c("sighting_id","sighting_geometry")])

# 4. Extract grid cell IDs for each sighting based on its coordinates
# Extract the cell number for each sighting point
sighting_gridcell <- terra::extract(
  grid_template, 
  sighting_v) |> 
  dplyr::rename(
    "sighting_rowname" = "ID", 
    "gridcell_id" = "lyr.1") |> 
  dplyr::mutate(
    sighting_rowname = as.character(sighting_rowname),
    gridcell_id = as.character(gridcell_id))

# 5. Combine the extracted cell IDs with the original sighting data
sighting <- base::cbind(sighting, sighting_gridcell["gridcell_id"])

# 6. Wrangling
sighting <- sighting |> 
  dplyr::filter(evc_group != "Plains Grasslands and Chenopod Shrublands") # n_burnt_after = 0

```


```{r}
head(sighting, 10)
```
### Data Summary     
```{r}
sighting |> 
  sf::st_drop_geometry() |> 
  group_by(sample) |> 
  summarise(
    "s.size" = n(), # number of individuals
    "observed" = length(unique(species)) # number of species
    ) 
```

### Standardising sampling periods  

Problem: Increased sighting effort after the fires. 

```{r}
# Line plot
ggplot(
  data = sighting |> 
  sf::st_drop_geometry() |> 
  dplyr::mutate(sighting_ym = format(sighting_date, "%Y-%m")) |>
  group_by(sighting_ym) |>
  summarise(sighting_count = n())
) +
  geom_line(
    aes(x = sighting_ym, y = sighting_count, group = 1),
    color = "grey30",
    linewidth = 1
  ) +
  # Line
  geom_point(aes(x = sighting_ym, y = sighting_count),
             size = 1.5) +
  theme(aspect.ratio = 1/5) + # Plot aspect ratio y/x
  # Highlight the fire period
  geom_rect(
    data = fire1920_timeframe |> dplyr::mutate(start_date = format(start_date, "%Y-%m"), end_date = format(end_date, "%Y-%m")),
    aes(xmin = start_date, xmax = end_date, ymin = -Inf, ymax = Inf),
    fill = report_pal[["fire"]],
    alpha = 0.2
  ) +
  # Annoation
  annotate(
    "text", x = format(fire1920_timeframe$start_date[1] %m-% months(2), "%Y-%m"), y = 22000,
    label = "Wildfires 2019/20",
    fontface = "bold",
    color = report_pal[["fire"]]) +
  labs(title = "Monthly number of sightings in the East Gippsland Shire",
       subtitle = "2017 - 2021",
       x = NULL, y = NULL)
```
Solution: Create temporal sampling periods with the same duration. 
For each grid cell, extract the ALA observations for the before-after fire and burnt-unburnt treatments.  

In burnt areas:  
  
Before-After treatment   
- After: One after-fire sampling period: Fire start date time-since-fire. Maximum time-since-fire is 548 days (18 months).   
- Before: Control the time-since-fire   

Step 1: Fixed post-fire period  
We established a fixed post-fire period of 548 days (18 months) for all areas impacted by the fire. This period began on the fire start date of each grid cell and extended for 18 months afterward. Reasoning behind the selection of 548 days (ref to Appendix 2). 

Step 2: For pre-fire samples, extract ALA sighting observations only from grid cells with post-fire observations (cells with sightings after the fire start date).

Step 3: Determining the pre-fire period  
To create comparable pre-fire periods, we first defined the pre-fire period starting date by subtracting a common number of days (1020 days) from the fire start date for each grid cell.   

Step 4: Creating multiple pre-fire periods  
Then, we generated nine pre-fire periods: the next pre-fire period starting were determined by offsetting the preceding one by 46 days (1.5 months). Each pre-fire period extended for 548 days (18 months) to match length of the post-fire period. The latest pre-fire period began on 22 May 2018, ensuring no overlap with the post-fire periods.  

Purpose of Controlling the time-since-fire: This careful construction of pre-fire sampling periods ensures that the pre-fire data collection occurred over timeframes mirroring those of the post-fire period. Hence, this minimises the potential influence natural fluctuation in biodiversity on the results. This control was crucial as biodiversity naturally varies over time due to factors, such as (1) cyclical patterns of abundance of many species, and (2) the long-term trends of environmental changes or species interactions. 

```{r}
#| eval: false 
# generate pre-fire periods starting date
seq(from = as.Date("2017-07-04"), by = "46 days", length.out = 9)

format(as.Date(fire1920_timeframe$start_date[1]) - 548, "%d %b %Y")  # "2018-05-22"
as.Date("2019-11-22") - 548
as.Date("2018-05-22") + 548
as.Date("2019-11-22") - as.Date("2018-02-19")
```
```{r}

# burnt_after_gridcell: grid cells with post-fire observations 
burnt_after_gridcell <- sighting |> 
  sf::st_drop_geometry() |> 
  # # Step 1 
  dplyr::filter(time_since_fire_days <= 548) |> # 50,439 rows
  select(gridcell_id) |> 
  unique() |> # 11,465 unique gridcell_id 
  pull()
  
sighting |> 
  sf::st_drop_geometry() |> 
  dplyr::filter(gridcell_id %in% burnt_after_gridcell) |> 
  # Step 2: Extract ALA sighting observations only from grid cells with post-fire observations 
  dplyr::filter(before_after_fire == "before") |>
  nrow()


```


```{r}
sighting |> 
  sf::st_drop_geometry() |>  
  dplyr::filter(sample == "burnt_after") |>
  select(gridcell_id,
         sighting_date,
         fire_start_date,
         time_since_fire_days) |> 
  dplyr::filter(time_since_fire_days <= 548) 
```


Number of unburnt and burn grid cell per vegetation class  

```{r}
sighting |> 
  sf::st_drop_geometry() |> 
  group_by(evc_group, burnt) |> 
  summarise(gridcell_count = n()) |> 
  pivot_wider(names_from = burnt, values_from = gridcell_count) |> 
  dplyr::mutate(gridcell_diff = burnt - unburnt)
```


### Transformation   
```{r}
# TRANSFORM INTO iNEXT SUPPORTED INPUT FORMAT
sp1 <- sighting |> 
  sf::st_drop_geometry() |> 
  group_by(sample, species) |> 
  summarise(n = n()) |> 
  tidyr::pivot_wider(names_from = sample, values_from = n, values_fill = NULL)
sp1 |> head(10)

# Convert df into list of numeric vectors 
sp1_list <- lapply(as.list(sp1[,-1]), na.omit) 

# sp1_list[c("burnt_after","burnt_before","unburnt_after","unburnt_before")]

# Preview list of vectors 
lapply(sp1_list, function(x) head(x, 10))
```

### Statistical Estimation   
```{r}
# ESTIMATE BIODIVERSITY
sp1_output <- estimateD(sp1_list, datatype="abundance", base="size", level=NULL, conf=0.95)

# Results
sp1_output

```

```{r}
# FOREST PLOT 
sp1_output |> 
  ggplot(aes(x=Assemblage, y=qD, color = Assemblage)) + 
  geom_point() + 
  ggplot2::geom_errorbar(aes(ymin = qD.LCL, ymax = qD.UCL)
                         #, linewidth = ebsize, width = ebw
  ) +
  facet_wrap(~Order.q) + 
  theme(legend.position = "bottom")
```

# Appendix  
## Appendix 2  

<!--TODO-->
Reasoning behind choosing 548 days (18 months) as the post-fire period
(1) Ecological significance. 
(2) Data availability.
(3) Comparison to prior studies. 
(4) Practical considerations.