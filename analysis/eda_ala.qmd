---
title: "EDA ALA sighting"
subtitle: "East Gippsland (extended area)" 
format:
  html:
    embed-resources: true
    toc: true
    toc-depth: 2
editor: source
execute:
  echo: false
  message: false
  warning: false
---

```{r library}
# Library
lib <- c("targets","tarchetypes",
         "tidyverse","sf","galah","terra",
         "tidyterra","tmap","leaflet","plotly")
invisible(lapply(lib, library, character.only = TRUE))
rm(lib)

# Targets config
tar_config_set(store = here::here("_targets"))

# Create a custom theme
theme_minimal_hpha0042 <- theme_minimal() +
  theme(
    # Plot title & subtitle
    plot.title = element_text(face = 'bold'),
    plot.title.position = "plot",
    plot.subtitle = element_text(color = "grey20", size = 12)
  )
theme_set(theme_minimal_hpha0042)
```

```{r}
#| label: load-data 
tar_load(vic_map)
tar_load(poly_fire_1920)
tar_load(poly_filter_ala)
tar_load(ala_sighting)
```

```{r}
ala_sighting |> sf::st_drop_geometry() |> select(speciesGroup) |> distinct() |> arrange()
```


```{r}
#| label: data-wrangling

# Data Wrangling 
ala_sighting <- ala_sighting |>
  # Add column
  dplyr::mutate(
    species_group = case_when(
    class == "Amphibia" ~ "Amphibians",
    speciesGroup == "Fungi" ~ "Fungi",
    .default = stringr::str_split_i(speciesGroup, " | ", -1)) 
  )
```

### Data aggregation

```{r}
# Define important Dates
fire_start_date <- lubridate::ymd("2019-11-21")
# fire_start_date %m+% months(18) [1] "2021-05-21"

# Crop fire extend 
poly <- sf::st_crop(st_make_valid(poly_fire_1920), st_make_valid(poly_filter_ala))

# Select species group ---------------------------------------------------------
# only those with ≥100 observations 
# [1] in burnt regions 
# [2] in the 18 months after fires were included for further analysis

ala_sighting_burnt <- 
  # [1] sighting in burnt regions
  sf::st_filter( 
    ala_sighting[c("species_group","eventDate","geometry")], 
    poly) 

selected_species_group <- ala_sighting_burnt |> 
  sf::st_drop_geometry() |> 
  # [2] in the 18 months after fires 
  filter(
    eventDate <= fire_start_date %m+% months(18)
  ) |>
  group_by(species_group) |>
  summarise(n = n()) |>
  filter(n >= 100) |>
  pull(species_group)

selected_species_group
```

Original data: 14 broad taxon groups `species_group`  
Selected species groups: only those with ≥100 observations [1] in burnt regions [2] in the 18 months after fires were included for further analysis


```{r}
ggplot() +
  geom_sf(data = vic_map,
          fill = "grey99", color = "grey70") +
  geom_sf(data = poly_fire_1920, fill = alpha("darkred",0.4)) + 
  geom_sf(data = poly_filter_ala, fill = "transparent", col = "orange", linewidth = 1)
```

```{r}
ggplot() +
  geom_sf(data = vic_map,
          fill = "grey99", color = "grey70") +
  geom_sf(
    data = ala_sighting |>
      filter(eventDate >= "2019-11-21" &
             eventDate <= ymd("2019-11-21") %m+% months(18)),
    aes(color = species_group),
    alpha = 0.5 , size = 1
  ) +
  # scale_color_manual(
    # values = pal,
    # name = "Species Group",
    # Legend
    # guide = guide_legend(nrow = 1, override.aes = list(size = 4, alpha = 1))
    # ) +
  # Zoom
  coord_sf(xlim = st_bbox(poly_filter_ala)[c("xmin", "xmax")], 
           ylim = st_bbox(poly_filter_ala)[c("ymin", "ymax")]) +
  labs(subtitle = "Jan 2017 - Jul 2023")
```
```{r}
ggplot() +
  geom_sf(
    data = vic_map, fill = "grey99", color = "grey70") +
  geom_sf(
    data = ala_sighting_burnt,
    alpha = 0.5 , size = 1
    ) +
  geom_sf(data = poly_fire_1920, fill = alpha("darkred",0.4)) +
  # Zoom
  coord_sf(xlim = st_bbox(poly_filter_ala)[c("xmin", "xmax")], 
           ylim = st_bbox(poly_filter_ala)[c("ymin", "ymax")]) +
  labs(subtitle = "Jan 2017 - Jul 2023")
```

```{r}
# Create grid cell
## Grid bounding box box extend
bbox_filter_ala <- st_bbox(ala_sighting, crs = sf::st_crs(7844))

## Grid sf object
grid <- st_make_grid(
    bbox_filter_ala, 
    cellsize = c(0.025, 0.025), # degree
    cellsize = units::as_units(25, "m"), # 25 x 25 m
    crs = st_crs(vic_map),
    what = "polygons",
    square = TRUE
    )
grid <- st_sf(grid_id = 1:length(lengths(grid)), grid) # Add grid ID

plot(st_bbox(grid |> filter(grid_id == 1)))

# No of grid: (0.25 x 0.25 degree) 12432

g1 <- sf::st_make_grid(
  bbox_filter_ala,
  cellsize = units::as_units(100, "km")) # length unit
```

```{r}
## Grid bounding box box extend
bbox_filter_ala <- sf::st_bbox(ala_sighting, crs = sf::st_crs(7844))

# Create a SpatRaster from scatch 
x <- terra::rast(
  # nrows = 100, ncols = 100,
  xmin = bbox_filter_ala[["xmin"]],
  xmax = bbox_filter_ala[["xmax"]],
  ymin = bbox_filter_ala[["ymin"]],
  ymax = bbox_filter_ala[["ymax"]],
  crs = "epsg:7844", 
  resolution = 1/3000,
)

terra::cellSize(x, unit = "m")

# Number of cells 
length(terra::cells(x)) # 69027904

# Number of SIGHTINGS in each grid
countgrid <- terra::rasterize(
  vect(ala_sighting), 
  x, 
  fun = "count", 
  background = NA)

# plot(countgrid)

ggplot() +
  geom_sf(
    data = vic_map, fill = "grey99", color = "grey70") +
  tidyterra::geom_spatraster(
    data = countgrid |> filter(!is.na(count)),
    aes(fill = count)
    ) +
  scale_fill_viridis_c(na.value = "transparent") +
  # Zoom
  coord_sf(xlim = st_bbox(poly_filter_ala)[c("xmin", "xmax")], 
           ylim = st_bbox(poly_filter_ala)[c("ymin", "ymax")]) +
  labs(subtitle = "Count of sightings in each 1000 m^2 grid cell")
```

